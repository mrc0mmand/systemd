name: mkosi

# Simple boot tests that build and boot the mkosi images generated by the mkosi config files in .mkosi.

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        distro:
          - arch

    steps:
    - uses: actions/checkout@v2
    - uses: systemd/mkosi@v9

    - name: Install
      run: sudo apt-get update && sudo apt-get install --no-install-recommends python3-pexpect

    - name: Symlink
      run: ln -s .mkosi/mkosi.${{ matrix.distro }} mkosi.default

    - name: Enable Arch's testing repository
      run: sudo sed -i '/\[core\]/i[testing]\n\{server\}\n' /usr/local/lib/python3.8/dist-packages/mkosi/__init__.py

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true

    - name: Build ${{ matrix.distro }}
      run: sudo python3 -m mkosi --password= --qemu-headless build

    - name: Boot ${{ matrix.distro }} systemd-nspawn
      run: sudo ./.github/workflows/test_mkosi_boot.py python3 -m mkosi --password= --qemu-headless boot

    - name: Boot ${{ matrix.distro }} QEMU
      run: sudo ./.github/workflows/test_mkosi_boot.py python3 -m mkosi --password= --qemu-headless qemu
